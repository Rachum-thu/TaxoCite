title: The Max- p-Regions Problem
abstract: In this paper, we introduce a new spatially constrained clustering problem
  called the max- p-regions problem. It involves the clustering of a set of geographic
  areas into the maximum number of homogeneous regions such that the value of a spatially
  extensive regional attribute is above a predefined threshold value. We formulate
  the max- p-regions problem as a mixed integer programming (MIP) problem, and propose
  a heuristic solution.
abstract_is_verbatim: true
segmented_markdown: "# The Max- p-Regions Problem\n\n## Abstract\n<block id=\"0\"\
  >\nIn this paper, we introduce a new spatially constrained clustering problem called\
  \ the max- p-regions problem. It involves the clustering of a set of geographic\
  \ areas into the maximum number of homogeneous regions such that the value of a\
  \ spatially extensive regional attribute is above a predefined threshold value.\
  \ We formulate the max- p-regions problem as a mixed integer programming (MIP) problem,\
  \ and propose a heuristic solution.\n\n</block>\n## 1 Introduction\n<block id=\"\
  1\">\nAccording to Fischer (1980), a homogeneous region consist of a set of spatially\
  \ contiguous areas which show a high degree of similarity regarding a set of attributes;\
  \ e.g., degree of diversity, per capita income, level of quality of life, etc. This\
  \ type of region is different from a functional region in the sense that the latter\
  \ consists of spatially contiguous areas with a high degree of interdependence;\
  \ e.g., high levels of commuting flows or commercial trade between them.\n\nThe\
  \ problem of aggregating areas into homogeneous regions is referred to by a host\
  \ of different names, including region-building (Byfuglien and Nordgard, 1973),\
  \ conditional clustering (Lefkovitch, 1980), clustering with relational constraints\
  \ (Ferligoj and Batagelj, 1982), constrained clustering (Legendre, 1987), contiguity\
  \ constrained clustering (Murtagh, 1992), regional clustering (Maravalle and Simeone,\
  \ 1995), contiguity constrained classification (Gordon, 1996), regionalization (Wise\
  \ et al., 1997), or clustering under connectivity constraints (Hansen et al., 2003).\
  \ The literature on this topic focuses on particular aspects of the problem such\
  \ as strategies to ensure spatial contiguity of each region, ways to measure homogeneity,\
  \ strategies to explore the solution space efficiently, and ways to check for solution\
  \ feasibility.\n\nFrom this basic problem (i.e., to aggregate areas into homogeneous\
  \ regions) other sub-branches have emerged, which add new constraints with the aim\
  \ to provide solutions to specific requirements in empirical applications. The most\
  \ important constraints are: (a) shape of the regions (e.g., compactness, similarity\
  \ to existing solutions); (b) equality of an attribute values across the regions\
  \ (e.g., population equality); and (c) membership constraints (e.g., boundary integrity).\
  \ Each one of these additional constraints has generated a number of contributions\
  \ suggesting different formulations and solution strategies.\n\nAlthough models\
  \ for solving either the problem of basic homogeneous regions or the extended versions\
  \ of this problem have been under development for the past four decades, the dramatic\
  \ increase in the availability of highly disaggregated spatial data and computational\
  \ resources provides the opportunity for regional scientists to explore new applications\
  \ of spatial aggregation models. In this process, new challenges appear that need\
  \ to be addressed with new formulations. One of those challenges is related to the\
  \ definition of the number of homogeneous regions to be designed (the scale problem);\
  \ many practitioners know that they need to aggregate areas into homogeneous regions\
  \ but they do not know how many regions they should create.\n\nWhile there is a\
  \ wide range of methods for finding an appropriate level of aggregation, choosing\
  \ among these methods is complicated by a number of factors: (a) the performance\
  \ of those methods is data dependent; (b) the choice of the number of regions is\
  \ complicated due to a wide variety of methods available; and, (c) the correct selection\
  \ of the method requires a deep knowledge of the properties of each one of the available\
  \ options. This situations has created a “barrier” for the use of the available\
  \ spatial clustering techniques in practice.\n\nOur experience with spatial aggregation\
  \ models has shown us that in many empirical applications the researcher does not\
  \ want to use spatial clustering as a tool for summarizing information or finding\
  \ the real number of clusters in the data, but as a tool for designing suitable\
  \ regions for analysis. In this scenario, although the researcher does not know\
  \ how many regions (clusters) need to be designed, she may know a condition that\
  \ must be satisfied by every region in order to make them suitable for the analysis.\
  \ That information can then be used as a way to endogenize the number of regions.\n\
  \nThis paper introduces the exact formulation and a solution method for a new type\
  \ of spatially constrained clustering that we coined as the max- p-regions problem.\
  \ In brief, the max- p-regions involves the aggregation of n areas into an unknown\
  \ maximum number of homogeneous regions, while ensuring that each region satisfies\
  \ a minimum threshold value imposed on a predefined spatially extensive attribute\
  \ (e.g., number of households per region, area per region, population per region,\
  \ etc.).\n\nA unique feature of this model is that the number of regions is modeled\
  \ as an endogenous parameter. Another important characteristic of this formulation\
  \ is that, opposite to many existing approaches, the way the model satisfies the\
  \ spatial contiguity constraint does not rely on imposing constraints on the shape\
  \ of the regions (i.e., maximal compactness); instead, the max-p-regions model lets\
  \ data dictate the shape of each region, which is a desirable characteristic in\
  \ many empirical applications in regional science.\n\nOne of the most promising\
  \ uses of the max- p-regions model is the definition of study regions. For example,\
  \ in the statistical analysis of rates for small area estimation (i.e., crime rates,\
  \ disease rates, unemployment rates) the precision with which the underlying rate\
  \ can be measured is inversely related to the size of the population within the\
  \ enumeration district. It is often desirable to combine small contiguous units\
  \ so as to increase the precision of the rate estimation. In these cases, the max-\
  \ p-regions algorithm can be used to design new study regions where (a) the loss\
  \ of observations is minimized because it seeks to perform the minimum number of\
  \ spatial aggregation; (b) the degree of aggregation bias is minimized, because\
  \ intraregional homogeneity is maximized; and, (c) the new regions ensure valid\
  \ statistical inference. It is also important to note that the max- p-regions model\
  \ could be used as a way to avoid subjectivity in the definition of both scale (number\
  \ of regions) and aggregation (shape of the regions) in applied analysis.\n\nThe\
  \ remainder of the paper is organized as follows. A formal statement of the max-\
  \ p-regions problem is formulated in the next section. A literature review is presented\
  \ in Section 3. The exact formulation of the max-p-regions problem is introduced\
  \ in Section 4. The heuristic algorithm for solving the max- p-regions problem,\
  \ including some computational experience, is presented in Section 5. The article\
  \ concludes with a summary and recommendations for future work.\n\n</block>\n##\
  \ 2 Problem statement\n<block id=\"2\">\nAreas:\nLet A ={A1, A2, ..., An} denote\
  \ a set n =|A| areas.\n\nAttributes:\nLet Aiy denote the attribute y of area Ai,\
  \ where y∈ Y ={1, 2, ..., m} with m≥ 1; and li denote a spatially extensive attribute\
  \ of area Ai.\n\nRelationship:\nLet d : A× A→ R+∪{ 0} be the dissimilarity between\
  \ areas based on the set of attributes Y such that dij ≡ d(Ai, Aj) satisfies the\
  \ conditions dij ≥ 0, dij = dij and dij = 0 for i, j = 1 , 2, . . . , n. Distance\
  \ functions can also be utilized; i.e., dij can also satify the subadditivity, or\
  \ triangle inequality, condition: dij≤ dik + dkj for i, j, k = 1, 2, . . . , n.\n\
  \nLet W = (V, E) denote the contiguity graph associated with A such that vertices\
  \ vi∈ V correspond to areas Ai∈ A and edges {vi, vj}∈ E if and only if areas Ai\
  \ and Aj share a common border. For the max- p-regions model W must be a connected\
  \ graph.\n\nFeasible Partitions of A:\nLet Pp ={R1, R2, ..., Rp} denote a partition\
  \ of areas A into p regions with 1≤ p≤ n such that:\n|Rk| > 0 for k = 1, 2, ...,\
  \ p;\nRk∩ Rk′ =∅ for k, k′ = 1, 2, ..., p ∧ k̸= k′; ⋃p k=1 Rk = A;\n∑ Ai∈Rk li≥\
  \ threshold for k = 1, 2, ..., p, and threshold∈ R+∪{ 0}|0≤ threshold≤ ∑ Ai∈A li;\n\
  W (Rk) is connected for k = 1, 2, ..., p.\n\nLet Π denote the set of all feasible\
  \ partitions of A.\n\nEvaluation criterion for a feasible partition Pp∈ Π:\nh(Rk)\
  \ = ∑ ij:Ai,Aj∈Rk,i≤j dij Heterogeneity of region k with Rk∈ Pp;\nH(Pp) = ∑p k=1\
  \ h(Rk) Total heterogeneity of partition Pp∈ Π.\n\nThe max-p-regions problem may\
  \ be formulated as:\nDetermine P∗ p∈ Π such that |P∗ p| = max(|Pp| : Pp∈ Π), and\n\
  ∄Pp∈ Π : |Pp| =|P∗ p| ∧ H(Pp) < H (P∗ p)\n\nNext we present a basic example to illustrate\
  \ an optimal solution for the max-p-regions problem. The objective is (1) to find\
  \ the maximum number of contiguous regions, p, needed to group the nine areas in\
  \ such a way that each region contains at least 120 houses (i.e., threshold = 120);\
  \ and (2) to find, within all solutions with p regions, the solution with the least\
  \ amount of regional heterogeneity based on y.\n\nAccording to the definition of\
  \ the max- p-regions problem, this optimal solution ( P∗ p ) implies the following\
  \ in sequential order.\n\n1. It is not possible to have more than two regions with\
  \ at least 120 houses each.\n2. There is not another feasible solution with two\
  \ regions with a total regional heterogeneity, H(Pp), lower than 672.6.\n\nThe bold\
  \ borders in the example outline the resulting regions. The regions capture the\
  \ spatial patterns by aggregating areas with similar values for variable y. Finally,\
  \ both regions have more than 120 houses each: 148 houses in region R1 and 123 in\
  \ region R2.\n\n</block>\n## 3 Literature review\n<block id=\"3\">\nIn the literature,\
  \ there are three types methods for designing homogeneous regions. The first type\
  \ of method designs the regions in two stages (Openshaw, 1973; Fischer, 1980). The\
  \ first of the two stages starts by applying a conventional clustering algorithm\
  \ to the areas without taking into account the geographical location of the areas\
  \ being aggregated. In this stage, the focus is placed on creating clusters, not\
  \ regions, of areas that are homogeneous in terms of a set of attributes, regardless\
  \ of geography. The second of the two stages defines regions as subsets of spatially\
  \ contiguous areas assigned to the same cluster. With this method the number of\
  \ resulting regions heavily depends on the spatial patterns of the attributes used\
  \ for calculating intraregional homogeneity (Openshaw and Rao, 1995).\n\nThe second\
  \ type of method consists of constructing homogeneous regions by including the x\
  \ and y coordinates of the centroids of the areas as two additional attributes in\
  \ a conventional clustering algorithm (Webster and Burrough, 1972; Murray and Shyy,\
  \ 2000). This is an indirect way to force geographically nearby areas to be assigned\
  \ to the same cluster. In this case, the resulting regions will tend to be geographically\
  \ compact and therefore spatially contiguous. Spatial contiguity in the final regional\
  \ solution depends on the weight given to the geographical attributes ( x and y\
  \ coordinates) compared to the weights given to the other attributes (Wise et al.,\
  \ 1997). An increase in the weight of the geographic coordinate attributes in the\
  \ clustering procedure will increase the chances of obtaining spatially contiguous\
  \ regions; As a trade-off, this increase in the geographic distance weighting compared\
  \ to the weighting of the other attributes will detract from meeting the objective\
  \ of obtaining intraregional homogeneity for the other attributes. One of the main\
  \ challenges when applying this strategy it to decide how geographical and non-geographical\
  \ attributes will be combined and weighted (Webster and Burrough, 1972; Cliff et\
  \ al., 1975; Perruchet, 1983).\n\nFor this paper, the key problem with the first\
  \ two types of methods is that they do not include a procedure for ensuring the\
  \ spatial contiguity of the regions. In both cases, this condition must be revised\
  \ a posteriori. Because of the simplicity of their formulations, a key strength\
  \ of these types of methods lies in their ability to handle large numbers of areas.\n\
  \nA third type of method for clustering areas, our focus, guarantees spatial contiguity\
  \ amongst the areas of each resulting region by explicitly including a spatial constraint\
  \ within the regionalization procedure. The advantage of this strategy is that the\
  \ objectives of spatial contiguity and intraregional homogeneity do not compete.\
  \ Information about the neighboring structure of the set of areas is used only as\
  \ an input for limiting the number of feasible solutions, and within this limited\
  \ number of spatially contiguous solutions is intraregional homogeneity assessed.\
  \ There is a wide range of strategies for guaranteeing spatial contiguity based\
  \ on information about the neighbouring structure. They can be classified into five\
  \ categories: (a) Adapted hierarchical clustering algorithms are where two clusters\
  \ are merged only if they share a common border (Lankford, 1969; Byfuglien and Nordgard,\
  \ 1973; Margules et al., 1985); (b) Seeded regions are where each region starts\
  \ growing from an initial area from which other neighbouring areas are attached\
  \ (Openshaw, 1977a); (c) Modification of an initial solution works by moving areas\
  \ between regions while preserving spatial contiguity (Openshaw and Rao, 1995; Ferligoj\
  \ and Batagelj, 1982); (d) Graph theory-based algorithms are where the areas and\
  \ their neighborhood structure are represented as a connected graph that needs to\
  \ be broken into connected subgraphs, while maximizing some intraregional homogeneity\
  \ criterion (Maravalle et al., 1997; Hansen et al., 2003; Assunção et al., 2006);\
  \ and, (e) Formulation of exact optimization models are where a subset of constraints\
  \ are responsible for satisfying the spatial contiguity of each region (Murray and\
  \ Shyy, 2000; Duque et al., 2010).\n\nThe use of one method or another is not an\
  \ arbitrary decision. For those problems where the shape of the regions should be\
  \ guided by the spatial distribution of the variables, the use of conventional clustering\
  \ with x and y coordinates are not appropriate because they always tend to generate\
  \ circular (compact) regions. Also, problems that do not require nested aggregations\
  \ at different scales will not ensure optimality by using adapted hierarchical clustering\
  \ algorithms because with these methods the solution at one scale is conditioned\
  \ to the solutions obtained at lower scales (Bunge, 1966). The method proposed in\
  \ this paper satisfies the contiguity constraint in two ways. First, in the exact\
  \ formulation we design constraints that borrow concepts from graph partitioning.\
  \ And second, for the solution method, we design an algorithm that constructs feasible\
  \ solutions, based on the seeded regions strategies, which are iteratively modified\
  \ while searching for improvements on the evaluation criterion.\n\n</block>\n##\
  \ 4 The exact formulation of the max- p-regions model\n<block id=\"4\">\nParameters:\n\
  i, I = Index and set of areas, I ={1,··· , n} ;\nk = index of potential regions,\
  \ k ={1,··· , n} ;\nc = index of contiguity order, c ={0,··· , q} , with q = (n−\
  \ 1);\nwij = { 1, if areas i and j share a border, with i, j∈ I and i̸= j 0, otherwise;\n\
  Ni = {j|wij = 1} , the set of areas that are adjacent to area i;\ndij = dissimilarity\
  \ relationships between areas i and j, with i, j∈ I and i < j ;\nh = 1 + ⌊log(∑\
  \ i ∑ j|j>i dij)⌋, which is the number of digits of the floor function of ∑ i ∑\
  \ j|j>i dij, with i, j∈ I;\nli = spatially extensive attribute value of area i,\
  \ with i∈ I;\nthreshold = minimum value for attribute l at regional scale.\n\nDecision\
  \ variables:\ntij = { 1, if areas i and j belong to the same region k, with i <\
  \ j 0, otherwise;\nxkc i = { 1, if areas i is assigned to region k in order c 0,\
  \ otherwise.\n\nMinimize:\nZ = ( − ∑n k=1 ∑n i=1 xk0 i ) ∗ 10h + ∑ i ∑ j|j>i dij\
  \ tij\n\nSubject to:\n∑n i=1 xk0 i ≤ 1 ∀k = 1,··· , n\n∑n k=1 ∑q c=0 xkc i = 1 ∀i\
  \ = 1,··· , n\nxkc i ≤ ∑ j∈Ni xk(c−1) j ∀i = 1,··· , n; ∀k = 1,··· , n; ∀c = 1,···\
  \ , q\n∑n i=1 ∑q c=0 xkc i li ≥ threshold ∗ ∑n i=1 xk0 i ∀k = 1,··· , n\ntij ≥ ∑q\
  \ c=0 xkc i + ∑q c=0 xkc j − 1 ∀i, j = 1,··· , n|i < j ; ∀k = 1,··· , n\nxkc i ∈\
  \ { 0, 1} ∀ i = 1,··· , n; ∀k = 1,··· , n; ∀c = 0,··· , q\ntij ∈ { 0, 1} ∀ i, j\
  \ = 1,··· , n|i < j\n\nIn this formulation potential regions are represented by\
  \ an index k. We call them “potential regions” because we do not know a priori how\
  \ many regions will be created. When a region k is created it starts from a “root”\
  \ area i, which is an area assigned to region k in order zero (i.e., X k0 i ). Each\
  \ region contains one and only one root area. The other areas are assigned to one\
  \ root according to an ordering system that ensures that each area either is adjacent\
  \ to the root area, or next to an area that is assigned to the same region with\
  \ a smaller order number. The contiguity conditions in this model represent an extension\
  \ of the ordered-area assignment conditions proposed by Cova and Church (2000),\
  \ who developed such conditions to enforce contiguity in a site design problem.\n\
  \nThe MIP model is formulated as a minimization problem with an objective function\
  \ that comprises two terms, one term that controls the number of regions, p, and\
  \ a second term that controls the total heterogeneity, H(Pp). The first term is\
  \ obtained by adding the number of areas designated as root areas (X k0 i ), and\
  \ the second term adds the pairwise dissimilarities between areas assigned to the\
  \ same region. Since the objective function is formulated as a minimization problem,\
  \ we multiply the first term by minus one.\n\nThese two terms are merged into one\
  \ single value, but not in the usual way (i.e., by multiplying each term by a weight).\
  \ Instead, we merge them in such a way that there is an implicit hierarchy where\
  \ the number of p regions comes first than the goal of reducing total heterogeneity.\
  \ We achieve this hierarchy by multiplying the first term by a scaling factor h\
  \ = 1 + ⌊log(∑ i ∑ j|j>i dij)⌋. For p regions the objective functions starts at\
  \ −p ∗ 10h. This value increases when we add the total heterogeneity, but h is big\
  \ enough that, regardless the value of this heterogeneity, the objective function\
  \ will never reach −(p− 1)∗ 10h. This formulation has three implications:\n- If\
  \ the algorithm finds a feasible solution with a higher value of p, the improvement\
  \ in the objective function will always be big enough that this new solution will\
  \ be preferred over any other solution with a smaller value of p.\n- For the same\
  \ value of p, solutions with lower heterogeneity will be preferred over solutions\
  \ with higher heterogeneity.\n- The third implication is derived from the two first,\
  \ and it is that we force the model to compare only total heterogeneities between\
  \ solutions with the same number of regions. Comparing heterogeneities between solutions\
  \ with different number of regions would be an unfair comparison.\n\nConstraints\
  \ (2) establish that a region k should not have more than one core area. A root\
  \ area for a region has a defined order of zero ( c = 0). Constraints (3) require\
  \ that each area i be assigned to exactly one region k and one contiguity order\
  \ c. Constraints (4) require that area i be assigned to region k at order c if and\
  \ only if an area j exist, in the adjacent neighborhood of i, that is assigned to\
  \ the same region k in order c− 1. Constraints (5) ensure that when a region is\
  \ created, the value of the spatially extensive attribute in that region will be\
  \ above the predefined threshold value. Constraints (6) select the pairwise dissimilarities\
  \ that must be taken into account for calculating the total heterogeneity. Thus,\
  \ the binary variable tij = 1 whenever areas i and j are assigned to the same region\
  \ k, regardless of the order in which they are assigned. Finally, constraint (7)\
  \ and (8) guarantee variable integrity.\n\nIn this formulation we do not impose\
  \ any constraint on the shape of the regions. Our formulation even allows for regions\
  \ in the solution that can appear as concentric rings around, for example, a Central\
  \ Business District.\n\nThe MIP formulation of the max- p-regions model is computationally\
  \ expensive. It has 3 n + (n− 1)n2 + n n2−n 2 constraints and (n− 1)n2 + n2−n 2\
  \ variables, which quickly make it intractable as the number of areas increases.\
  \ However there are some options that can be considered to reduce the size of the\
  \ problem:\n\n1. Each area i with li≥ threshold can be assigned to a different region\
  \ k by adding constraints of the type X k0 i = 1.\n2. The upper limit of the indexes\
  \ k and c can be reduced, because they were set for very extreme cases. Currently\
  \ we do not have the decision rules to define how much the upper limits of k and\
  \ c can be reduced without affecting optimality.\n3. It is clear that, for a given\
  \ solution, the objective function will not be affected if we modify the index of\
  \ the region, or the order of assignment, as long as the set of areas per region\
  \ is not modified. This implies that, when using the branch and bound method, the\
  \ optimal solution will exist in multiple branches of the solution tree. Thus, a\
  \ Depth-first branching direction may reduce the solution time.\n4. If we take into\
  \ account that any area can be the root of its region, then we can apply the “1\
  \ in 1” formulation proposed by Rosing and ReVelle (1986) within the context of\
  \ flow capturing model. According to this formulation, a single area i can be arbitrarily\
  \ assigned to one specific region without degrading the problem or the objective\
  \ function. Thus, we can reduce computation time by adding the constraint X1,0 1\
  \ without affecting optimality.\n\nTo illustrate the complexity of the max- p-regions\
  \ we solved nineteen problems with different number of areas (n) and threshold values\
  \ (threshold). The attributes y, from which the dissimilarities dij are calculated,\
  \ were simulated as spatial autoregressive (SAR) processes with a spatial autocorrelation\
  \ parameter ρ = 0.8, mean = 0 , and the rook criterion of contiguity for constructing\
  \ the spatial weights. The spatially extensive attributes l where generated from\
  \ a discrete uniform distribution between 10 and 15. Only four problems were solved\
  \ to optimality, and feasible solutions were obtained for six problems. For the\
  \ other nine problems CPLEX did not find a feasible solution after four hours. It\
  \ is clear that with the commonly available computational power we currently need\
  \ to use heuristics to solve meaningfully large problems.\n\n</block>\n## 5 Heuristic\
  \ solution methods\n<block id=\"5\">\nIn this section we propose a heuristic solution\
  \ for the max- p-regions problem. The heuristic is presented in Pseudocode 1 and\
  \ comprises two phases, a construction phase and a local search phase. The construction\
  \ phase generates a set of feasible solutions, and the local search phase applies\
  \ iterative modifications to those feasible solutions in order to improve the evaluation\
  \ criterion. At the end, the heuristic returns the best solution found.\n\nPseudocode\
  \ 1: Max-p-regions\n```\nA : Set of areas,\nl : Spatially extensive attribute of\
  \ areas,\nd : Pairwise dissimilarities between areas,\nW : Neighbourhoods,\nthreshold\
  \ : Constraint on attribute l at regional level.\n\nPbestp = ∅, best partition.\n\
  het = ∞\nΠ = ∅, set of feasible partitions.\nΨ = ∅, set of partitions before enclaves\
  \ assignment.\nmaxP = 0, maximum number of regions.\n\nConstruction Phase:\nfor\
  \ i = 1, 2,··· , maxitr do\n{\n  ψ, ε, A′ = GrowRegions(A, l, d, W, threshold)\n\
  \  p = |ψ|, number of regions in partition ψ\n  if p > maxP then {Ψ = ψ; maxP =\
  \ p}\n  if p = maxP then {Ψ = Ψ ∪ ψ}\n  if p < maxP then {pass}\n}\nfor ψ in Ψ do\n\
  {\n  Pf easible = AssignEnclaves(ψ, Aa, ε, d, W)\n  Π = Π ∪ Pf easible\n}\n\nLocal\
  \ Search Phase:\nfor Pf easible in Π do\n{\n  Pcurrentp = LocalSearch(Pf easible)\n\
  \  if H(Pcurrentp) < het then {het = H(Pcurrentp); Pbestp = Pcurrentp}\n}\nreturn\
  \ Pbestp\n```\n\n</block>\n### 5.1 Construction phase\n<block id=\"6\">\nThe construction\
  \ of a feasible solution is divided in two phases: growing phase (see Pseudocode\
  \ 2), and enclaves assignment (see Pseudocode 3). During the growing phase the algorithm\
  \ selects at random an unassigned area, which is the “seed area” of a growing region.\
  \ Then, neighbouring unassigned areas are added to the initial seed until the region\
  \ reaches the minimum threshold value. The algorithm selects a new seed area to\
  \ start growing a new region. This process is repeated until it is not possible\
  \ to grow new regions that satisfy the threshold value. Those areas that are not\
  \ assigned to a region are known as “enclaves.” At the end of the growing phase,\
  \ the algorithm finished with a set of partial solutions where each solution is\
  \ composed by a set of growing regions and a set of enclave areas.\n\nThe number\
  \ of feasible growing regions may change from run to run. For this reason the algorithm\
  \ repeats this procedure multiple times (maxitr) and keeps only those solutions\
  \ where the number of growing regions is equal to the maximum number of regions\
  \ obtained in prior iterations. Each partial solution is then passed to the process\
  \ of enclaves assignment. In this phase each enclave area must be assigned to one\
  \ neighbouring growing region according to a measure of similarity. Once all the\
  \ partial solutions have passed through the enclave assignment process, the algorithm\
  \ has a set of feasible solutions, all of them with the same number of regions.\n\
  \nPseudocode 2: GrowRegions\n```\nA, l, d, W, threshold\n\nComment: Grow regions\
  \ from initial seeds such that the value of attribute l\nin each region is above\
  \ threshold.\n\nΨ = ∅, set of partitions before enclaves assignment.\nε = ∅, set\
  \ of enclave areas.\nAu = A, set of unassigned areas.\nAa = ∅, set of assigned areas.\n\
  \nwhile Au ≠ ∅ do\n{\n  Ak = select, at random, one area from Au.\n  Au = Au − {Ak},\
  \ remove area Ak from set Au.\n  Aa = Aa ∪ {Ak}, add area Ak to set Aa.\n  if lk\
  \ ≥ threshold then {Rk = {Ak}, area Ak becomes a region by itself. Ψ = Ψ ∪ {Rk}}\n\
  \  if lk < threshold then\n  {\n    Rk = {Ak}, start a growing region seeded at\
  \ area Ak.\n    N = neighbours(Ak) − Aa, set of neighbouring unassigned areas of\
  \ Ak.\n    L = lk, value of attribute l in area Ak.\n    feasible = 1\n    while\
  \ T < threshold do\n    {\n      if N ≠ ∅ then\n      {\n        Ai = area in N\
  \ that minimizes the greedy adaptative function g(Ai) = ∑ j∈Rk dij\n        Rk =\
  \ Rk ∪ {Ai}\n        N = (N − {Ai}) ∪ neighbours(Ai) − Aa\n        T = T + li\n\
  \        Au = Au − {Ai}\n        Aa = Aa ∪ {Ai}\n      }\n      if N = ∅ and T <\
  \ threshold then\n      {\n        ε = ε ∪ Rk\n        feasible = 0\n        Au\
  \ = Au ∪ Rk\n        Aa = Aa − Rk\n        break, leave the while loop.\n      }\n\
  \    }\n    if feasible = 1 then Ψ = Ψ ∪ {Rk}\n  }\n}\nreturn Ψ, ε, Aa\n```\n\n\
  Pseudocode 3: AssignEnclaves\n```\nψ, Aa, ε, d, W\n\nComment: Assign each enclave\
  \ in ε to one growing region in partition ψ.\n\nwhile ε ≠ ∅ do\n{\n  Ai = select\
  \ an area Ai in ε that shares a border with at least one area in Aa.\n  η = regions\
  \ η ⊂ ψ that share border with area Ai.\n  Rk = region Rk ⊂ η that minimizes the\
  \ greedy adaptative function g(Ai, Rk) = ∑ j∈Rk dij.\n  Rnewk = Rk ∪ {Ai}\n  ψ =\
  \ ψ − {Rk} ∪ {Rnewk}, update region Rk in ψ.\n  Aa = Aa ∪ {Ai}, update set of assigned\
  \ areas.\n  ε = ε − Ai, update set of enclaves.\n}\nPf easible = ψ, at this point\
  \ all the areas have been assigned to a region.\nreturn Pf easible\n```\n\n</block>\n\
  ### 5.2 Local search phase\n<block id=\"7\">\nEach one of these feasible solutions\
  \ generated during the construction phase is then improved by applying a local search\
  \ algorithm. The local search algorithm iteratively modifies the solution while\
  \ seeking for improvements on the evaluation criterion. The set of new solutions\
  \ that can be obtained from a current solution is known as the set of neighbouring\
  \ solutions. There exist several ways to create this set: (a) moving one area from\
  \ its regions to a neighbouring region, (b) swapping areas between two regions,\
  \ (c) merging two regions and splitting them into two new regions, or (d) combining\
  \ two feasible solutions into a new different feasible solution using genetic algorithms\
  \ operators. Regardless of the strategy for creating neighbouring solution, the\
  \ condition is that each neighboring solution must generate a feasible solution.\
  \ In this paper, we define a neighbouring solution as the new feasible solution\
  \ obtained by moving one area from its current region (donor region) to another\
  \ neighboring region (recipient region). This neighbouring function has been applied\
  \ by Bozkaya et al. (2003), Openshaw and Rao (1995), Ricca and Simeone (2008), Blais\
  \ et al. (2003), and Bong and Wang (2004) for different types of spatial clustering\
  \ problems.\n\nWe consider three different local search algorithms with the aim\
  \ of determining which one performs better for the max-p-regions problem: Simulated\
  \ Annealing (Kirkpatrick et al., 1983), Tabu Search (Glover, 1977) and Greedy Algorithm.\n\
  \n#### 5.2.1 Simulated annealing\nSimulated Annealing is described in Pseudocode\
  \ 4. This algorithm starts from an initial feasible solution. Then, a neighbouring\
  \ feasible solution is selected at random. If the neighbouring solution is better\
  \ than the current solutions, then the move is accepted. If the neighbouring solution\
  \ does not improve the current solution, then the transition to the new solution\
  \ is allowed with an acceptance probability given by the Boltzmann’s equation, p\
  \ = e−∆H/T , where ∆ H is the change in the evaluation criterion, and T is the current\
  \ temperature. At each iteration the temperature T gradually decreases at a given\
  \ cooling rate α. Thus, as the algorithm progresses probability of accepting a non-improving\
  \ move approaches to zero. The algorithm stops when T reaches a predefined value\
  \ ϵ. The key parameter in this algorithm is the cooling rate α.\n\nPseudocode 4:\
  \ Local Search: SimulatedAnnealing\n```\nPf easible, T0, α, ϵ\n\nP′p = Pf easible,\
  \ Best local optimum\nPcurrentp = Pf easible, Current solution\nT = T0, Initial\
  \ temperature\nwhile T ≥ ϵ do\n{\n  Select at random a feasible neighbouring solution\
  \ Pnewp of Pcurrentp\n  if H(Pnewp) < H(P′p) then\n  {\n    P′p = Pnewp\n    Pcurrentp\
  \ = Pnewp\n  }\n  else if e−∆/T > random then\n    Pcurrentp = Pnewp\n  T = αT\n\
  }\nreturn (P′p)\n```\n\n#### 5.2.2 Tabu search algorithm\nThe Tabu search algorithm\
  \ is presented in Pseudocode 5. This metaheuristic is provided with a good capacity\
  \ of escaping from local optimal solution by allowing a temporal worsening of the\
  \ evaluation criterion with the hope of discovering a new solution better that the\
  \ best solution obtained so far. It starts from an initial feasible solution. From\
  \ this point the algorithm moves to the best neighbouring solution even if this\
  \ move causes a deterioration of the evaluation criterion (total heterogeneity).\
  \ To prevent cycles, the reverse move is forbidden, or tabu, for a predefined number\
  \ of iterations (lengthTabu). A tabu move is allowed only if the move yields a solution\
  \ better than the best obtained so far (aspirational criterion). The algorithm stops\
  \ when a total of convTabu iterations have been performed without improving the\
  \ aspirational criterion. According to the literature, the most critical parameter\
  \ in this heuristic is the length of the tabu list, lengthTabu.\n\nPseudocode 5:\
  \ Local Search: TabuSearch\n```\nPf easible, lengthTabu, convTabu\n\nP′p = Pcurrentp\
  \ = Pf easible\ntabuList = {}\nc = 1\nwhile c ≤ convTabu do\n{\n  N = Set of feasible\
  \ neighbors of Pcurrentp\n  if N = ∅ then c = convTabu\n  else\n  {\n    for Pnewp\
  \ in N do\n    {\n      if Pnewp ∉ tabuList then\n      {\n        if H(Pnewp) <\
  \ H(P′p) then\n        {\n          P′p = Pnewp\n          Pcurrentp = Pnewp\n \
  \         c = 1\n          N = {}\n          tabuList.add(Pnewp)\n        }\n  \
  \      else\n        {\n          Pcurrentp = Pnewp\n          c = c + 1\n     \
  \     N = {}\n        }\n      }\n      else\n      {\n        if H(Pnewp) < H(P′p)\
  \ then\n        {\n          P′p = Pnewp\n          Pcurrentp = Pnewp\n        \
  \  c = 1\n          N = {}\n          tabuList.add(Pnewp)\n        }\n        else\n\
  \        {\n          N = N − Pnewp\n          tabuList.pop()\n        }\n     \
  \ }\n    }\n  }\n}\nreturn (P′p)\n```\n\n#### 5.2.3 Greedy algorithm\nThe Greedy\
  \ algorithm, described in Pseudocode 6, starts from an initial feasible solution,\
  \ and selects a neighbouring solution at random. The neighbouring solution is allowed\
  \ only if it improves the current solution. The algorithm stops when there is no\
  \ neighbouring solution that improves the current solution. The Greedy algorithm\
  \ is fast but it may easily get trapped into a local optimum.\n\nPseudocode 6: Local\
  \ Search: Greedy\n```\nPf easible\n\nP′p = Pf easible\nflag = 1\nwhile flag do\n\
  {\n  N = Set of feasible neighbors of P′p that improve the solution\n  if N ≠ ∅\
  \ then P′p = Randomly selects an element of N\n  else flag = 0\n}\nreturn (P′p)\n\
  ```\n\nTwo are the main challenges in the application of local search algorithms\
  \ to the problem of spatial clustering: (a) to avoid getting trapped in a local\
  \ optimal solution, and (b) to find feasible neighboring solutions efficiently.\
  \ However, these techniques have been widely applied in other problems that impose\
  \ spatial contiguity constraint. For example, simulated annealing has been applied\
  \ in political districting by Browdy (1990), Macmillan and Pierce (1994), Macmillan\
  \ (2001), and Ricca and Simeone (2008); in zone design by Openshaw and Rao (1995);\
  \ and in police districting by D’amico et al. (2002). Tabu search has been applied\
  \ in political districting by Bozkaya et al. (2003), Bong and Wang (2004), and Ricca\
  \ and Simeone (2008); in zone design by Openshaw and Rao (1995); and in home care\
  \ districting by Blais et al. (2003). And the greedy algorithm has been applied\
  \ in constrained clustering by Bodin (1973), Fischer (1980), and Ferligoj and Batagelj\
  \ (1982); in political districting by Nagel (1965), Liittschwager (1973), Moshman\
  \ and Kokiko (1973), Horn (1995), Ricca and Simeone (2008), and Yamada (2009); and\
  \ in zone design by Openshaw (1977a), and Openshaw and Rao (1995).\n\n</block>\n\
  ### 5.3 Computational experiments\n<block id=\"8\">\nIn this section we study the\
  \ performance of the three local search algorithms presented above. The irregular\
  \ lattices were obtained from the sample data sets available at the GeoDa Center\
  \ for Geospatial Analysis and Computation. We used two different values for ρ, 0.6\
  \ and 0.9, in order to evaluate whether there is a change in the performance of\
  \ the algorithms at different levels of spatial dependence.\n\nWe used the following\
  \ characteristics: regular lattices 20x20 (n = 400), 33x33 (n = 1,056), 55x56 (n\
  \ = 3,080); Sacramento census tracks (n = 403); Colombian municipalities (n = 1,068);\
  \ US census tracks (n = 3,085); neighbourhoods type rook; y SAR (ρ = 0.6) and SAR\
  \ (ρ = 0.9); l Discrete Uniform [0,100]; threshold (TH) 100, 300, and 500.\n\nTable\
  \ 4 presents the parameters we use for the local search algorithms. In both algorithms\
  \ we use different values for the key parameters: in Simulated Annealing (SA) we\
  \ use two different values for the cooling rate ( α), and in Tabu Search we use\
  \ three different values for the length of the tabu list. This gives a total of\
  \ six algorithms: Greedy, SA-0.9, SA-0.998, Tabu-10, Tabu-24, and Tabu-85. All the\
  \ values for the parameters are based on previous experiments presented in Ríos-Mercado\
  \ and Fernández (2009), Ricca and Simeone (2008), Bong and Wang (2004), Blais et\
  \ al. (2003), Bozkaya et al. (2003), D’amico et al. (2002), Macmillan (2001), Openshaw\
  \ and Rao (1995), Macmillan and Pierce (1994), and Browdy (1990).\n\nIn order to\
  \ make the results comparable, we generate an initial feasible solution at random\
  \ for each combination of lattice, ρ, and threshold. Then, we run the six local\
  \ search algorithm with the same starting solution. This process is repeated ten\
  \ times with different starting solutions. Thus, we solve a total of 2,160 problems\
  \ (6 lattices × 2 values of ρ × 3 Threshold values × 6 algorithms × 10 repetitions).\n\
  \nOur results are presented in summary form. Each experiment reports: the number\
  \ of times that each algorithm reached the best known solution; the average reduction\
  \ of the evaluation criterion (total heterogeneity), calculated as [H(P initial)\
  \ − H(P final)] / H(P initial), where H(P initial) is the total heterogeneity of\
  \ the initial feasible solution, and H(P final) is the total heterogeneity at the\
  \ end of the local search; and the average running times in seconds.\n\nThe results\
  \ show that Tabu-85 reached the best known solution most frequently, followed by\
  \ Tabu-24 and Tabu-10. The SA-0.998 and Greedy algorithms are significantly inferior,\
  \ followed by SA-0.9. Our results suggest that the larger the length of the tabu\
  \ list, the higher the possibilities are to get the best solution. It is also important\
  \ to note that longer tabu lists do not imply a significant change in the running\
  \ times.\n\nA comparison of Simulated Annealing with Tabu Search shows that, on\
  \ average, to get an additional reduction of 0.73% in the total heterogeneity using\
  \ Tabu Search causes the running time to an increase by a factor of 4.84. Depending\
  \ on the context of the application, this trade-off can be very expensive.\n\nContrary\
  \ to our expectations, there is not a significant difference in the performance\
  \ of the algorithms at different levels of spatial dependence; i.e., having clearer\
  \ spatial patterns neither helps the algorithms to converge faster nor to reach\
  \ a higher reduction of the initial objective function value. This finding implies\
  \ that it is not necessary to consider the level of spatial dependence of the variables\
  \ in y when calibrating the parameters of the algorithms.\n\nDifferences between\
  \ regular and irregular lattices have a significant impact on the evaluation criterion\
  \ and solution times. For irregular lattices, we found a 12.84% reduction in the\
  \ capacity of the algorithms to reduce the evaluation criterion. However, the algorithms\
  \ converged 8.77% faster with irregular lattices when compared with regular. Increasing\
  \ the threshold value (TH) from 100 to 500 yields a 34.78% reduction in running\
  \ time for Tabu Search. This effect is the opposite for the other two algorithms:\
  \ Simulated Annealing produces increases in running time by an average of 84.45%,\
  \ and the Greedy algorithm multiplies the average running time by a factor of 2.13.\n\
  \n</block>\n## 6 Conclusions and future research\n<block id=\"9\">\nIn this paper\
  \ we presented a new type of constrained clustering problem that we coined as the\
  \ max- p-regions problem. This problem involves the aggregation of small areas into\
  \ the maximum number of homogeneous regions such that the regional value of a spatially\
  \ extensive attribute is above a minimum threshold value.\n\nThere are many potential\
  \ applications of our model. For example, the max-p can be used in the design of\
  \ study regions that allow valid statistical inference in the presence of spatial\
  \ heteroskedasticity such as in spatial epidemiology studies that require a fair\
  \ comparison of rate estimates across regions. In addition, our approach can be\
  \ explored as a way to control for spurious spatial autocorrelation while minimizing\
  \ the aggregation bias.\n\nClassical problems in the literature can be also reformulated\
  \ as a max-p-regions problem. For example, all the formulations on police districting\
  \ and sales territory alignment assume that the headquarters or stores are already\
  \ located in the territory. This may be an overly strict assumption. For instance,\
  \ it is plausible that a researcher is confronted with a situation where those facilities\
  \ do not yet exist or they need to be reallocated. Then, the max- p-regions model\
  \ can be used to aggregate the areas into regions such that the regions are homogeneous\
  \ in terms of customer characteristics or crime types, and each region contains\
  \ a minimum amount of potential customers or emergency calls. Next, once the regions\
  \ are designed, one can decide the best location of facility within each region\
  \ at a subsequent stage.\n</block>"
